<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DIVINIA OS ‚Äî Centro de Operaciones</title>
<link href="https://fonts.googleapis.com/css2?family=Sora:wght@300;400;500;600;700;800&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
:root{
--bg:#060708;--bg2:#0C0E14;--bg3:#12141D;--bg4:#1A1D2B;
--border:rgba(255,255,255,0.06);--border2:rgba(255,255,255,0.1);
--text:#F0F0F5;--text2:#8B8D9E;--text3:#5A5C6E;
--violet:#8B5CF6;--cyan:#06D6A0;--red:#EF4444;--yellow:#F59E0B;--blue:#3B82F6;--green:#10B981;--orange:#F97316;
--grad:linear-gradient(135deg,#8B5CF6,#06D6A0);
--font:'Sora',sans-serif;--body:'DM Sans',sans-serif;
}
body{font-family:var(--body);background:var(--bg);color:var(--text);display:flex;min-height:100vh}

/* SIDEBAR */
.sidebar{width:240px;background:var(--bg2);border-right:1px solid var(--border);display:flex;flex-direction:column;position:fixed;top:0;left:0;bottom:0;z-index:50;transition:transform .3s}
.sidebar-logo{display:flex;align-items:center;gap:12px;padding:20px;border-bottom:1px solid var(--border)}
.logo-mark{width:36px;height:36px;border-radius:10px;background:var(--grad);display:flex;align-items:center;justify-content:center;font-family:var(--font);font-weight:800;font-size:16px;color:#fff}
.logo-text{font-family:var(--font);font-weight:700;font-size:17px;letter-spacing:-0.5px}
.logo-ver{font-size:10px;color:var(--cyan);background:rgba(6,214,160,0.1);border:1px solid rgba(6,214,160,0.2);padding:2px 8px;border-radius:100px;font-weight:600;margin-left:4px}
.sidebar nav{flex:1;padding:12px;display:flex;flex-direction:column;gap:2px}
.nav-item{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:8px;cursor:pointer;font-size:13px;color:var(--text2);transition:all .2s;border:1px solid transparent}
.nav-item:hover{background:var(--bg3);color:var(--text)}
.nav-item.active{background:rgba(139,92,246,0.1);color:var(--violet);border-color:rgba(139,92,246,0.2);font-weight:600}
.nav-item .icon{font-size:16px;width:20px;text-align:center}
.nav-label{font-size:10px;text-transform:uppercase;letter-spacing:1px;color:var(--text3);padding:16px 12px 6px;font-weight:600}
.sidebar-footer{padding:16px;border-top:1px solid var(--border);font-size:11px;color:var(--text3);text-align:center}

/* MAIN */
.main{margin-left:240px;flex:1;min-height:100vh;padding:0}
.topbar{display:flex;align-items:center;justify-content:space-between;padding:16px 28px;border-bottom:1px solid var(--border);background:var(--bg);position:sticky;top:0;z-index:40}
.topbar h1{font-family:var(--font);font-size:18px;font-weight:600}
.topbar-right{display:flex;align-items:center;gap:12px}
.topbar-date{font-size:12px;color:var(--text2)}
.topbar-user{display:flex;align-items:center;gap:8px;padding:6px 12px;border-radius:8px;background:var(--bg3);font-size:12px;font-weight:500}
.content{padding:24px 28px}
.section{display:none}
.section.active{display:block}

/* KPI CARDS */
.kpi-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:24px}
.kpi-card{background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:20px}
.kpi-label{font-size:11px;color:var(--text2);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px}
.kpi-value{font-family:var(--font);font-size:28px;font-weight:700;margin-bottom:4px}
.kpi-sub{font-size:11px;color:var(--text3)}
.kpi-card.highlight{border-color:rgba(139,92,246,0.3);background:linear-gradient(135deg,rgba(139,92,246,0.05),rgba(6,214,160,0.05))}

/* CARDS & GRIDS */
.card{background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:20px}
.card-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
.card-title{font-family:var(--font);font-size:14px;font-weight:600}
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:24px}
.grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px;margin-bottom:24px}

/* BUTTONS */
.btn{padding:8px 16px;border-radius:8px;font-size:12px;font-weight:600;cursor:pointer;border:1px solid var(--border);background:var(--bg3);color:var(--text);transition:all .2s;font-family:var(--body);display:inline-flex;align-items:center;gap:6px}
.btn:hover{border-color:var(--border2);background:var(--bg4)}
.btn-primary{background:var(--violet);border-color:var(--violet);color:#fff}
.btn-primary:hover{opacity:0.9}
.btn-success{background:var(--green);border-color:var(--green);color:#fff}
.btn-sm{padding:5px 10px;font-size:11px}
.btn-danger{background:var(--red);border-color:var(--red);color:#fff}

/* TABLES */
.table-wrap{overflow-x:auto}
table{width:100%;border-collapse:collapse;font-size:13px}
th{text-align:left;padding:10px 12px;font-size:11px;text-transform:uppercase;letter-spacing:0.5px;color:var(--text3);border-bottom:1px solid var(--border);font-weight:600}
td{padding:10px 12px;border-bottom:1px solid var(--border)}
tr:hover td{background:rgba(255,255,255,0.02)}

/* BADGES */
.badge{display:inline-block;padding:3px 10px;border-radius:100px;font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:0.3px}
.badge-nuevo{background:rgba(59,130,246,0.15);color:var(--blue)}
.badge-contactado{background:rgba(249,115,22,0.15);color:var(--orange)}
.badge-propuesta{background:rgba(139,92,246,0.15);color:var(--violet)}
.badge-negociacion{background:rgba(245,158,11,0.15);color:var(--yellow)}
.badge-cerrado{background:rgba(16,185,129,0.15);color:var(--green)}
.badge-activo{background:rgba(6,214,160,0.15);color:var(--cyan)}
.badge-en_desarrollo{background:rgba(139,92,246,0.15);color:var(--violet)}
.badge-aprobado{background:rgba(59,130,246,0.15);color:var(--blue)}
.badge-revision{background:rgba(245,158,11,0.15);color:var(--yellow)}
.badge-entregado{background:rgba(16,185,129,0.15);color:var(--green)}
.badge-soporte{background:rgba(6,214,160,0.15);color:var(--cyan)}

/* SCORE BAR */
.score-bar{width:60px;height:6px;background:var(--bg4);border-radius:3px;overflow:hidden;display:inline-block;vertical-align:middle;margin-right:6px}
.score-fill{height:100%;border-radius:3px;transition:width .3s}

/* PROGRESS BAR */
.progress-bar{width:100%;height:8px;background:var(--bg4);border-radius:4px;overflow:hidden;margin-top:4px}
.progress-fill{height:100%;background:var(--grad);border-radius:4px;transition:width .5s}

/* MODAL */
.modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:100;display:none;align-items:center;justify-content:center;backdrop-filter:blur(4px)}
.modal-overlay.show{display:flex}
.modal{background:var(--bg2);border:1px solid var(--border2);border-radius:16px;padding:28px;width:90%;max-width:520px;max-height:85vh;overflow-y:auto}
.modal h2{font-family:var(--font);font-size:18px;margin-bottom:20px}
.form-group{margin-bottom:14px}
.form-group label{display:block;font-size:11px;color:var(--text2);margin-bottom:5px;text-transform:uppercase;letter-spacing:0.5px;font-weight:600}
.form-group input,.form-group select,.form-group textarea{width:100%;padding:10px 12px;border-radius:8px;border:1px solid var(--border2);background:var(--bg3);color:var(--text);font-size:13px;font-family:var(--body)}
.form-group textarea{resize:vertical;min-height:60px}
.form-group input:focus,.form-group select:focus,.form-group textarea:focus{outline:none;border-color:var(--violet)}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.form-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:20px}

/* AGENDA */
.task-item{display:flex;align-items:center;gap:12px;padding:12px;border-radius:8px;border:1px solid var(--border);margin-bottom:8px;transition:all .2s}
.task-item:hover{border-color:var(--border2)}
.task-check{width:20px;height:20px;border-radius:6px;border:2px solid var(--border2);cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all .2s}
.task-check:hover{border-color:var(--violet)}
.task-item.done .task-check{background:var(--green);border-color:var(--green)}
.task-item.done .task-check::after{content:'‚úì';color:#fff;font-size:12px}
.task-item.done .task-text{text-decoration:line-through;opacity:0.5}
.task-text{flex:1;font-size:13px}
.task-meta{font-size:11px;color:var(--text3);display:flex;gap:8px;align-items:center}
.task-delete{cursor:pointer;opacity:0.3;transition:opacity .2s;font-size:14px}
.task-delete:hover{opacity:1;color:var(--red)}
.priority-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.priority-alta{background:var(--red)}
.priority-media{background:var(--yellow)}
.priority-baja{background:var(--text3)}

/* FINANCE */
.finance-summary{display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px;margin-bottom:24px}
.finance-card{padding:20px;border-radius:12px;border:1px solid var(--border)}
.finance-card.ingresos{background:rgba(16,185,129,0.05);border-color:rgba(16,185,129,0.2)}
.finance-card.gastos{background:rgba(239,68,68,0.05);border-color:rgba(239,68,68,0.2)}
.finance-card.balance{background:rgba(139,92,246,0.05);border-color:rgba(139,92,246,0.2)}
.finance-amount{font-family:var(--font);font-size:24px;font-weight:700;margin:8px 0 4px}
.finance-label{font-size:11px;color:var(--text2);text-transform:uppercase;letter-spacing:0.5px}

/* DEPT GRID */
.dept-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
.dept-card{padding:16px;border-radius:10px;border:1px solid var(--border);background:var(--bg2);display:flex;align-items:center;gap:12px}
.dept-icon{font-size:20px;width:36px;height:36px;display:flex;align-items:center;justify-content:center;border-radius:8px;background:var(--bg3)}
.dept-info{flex:1}
.dept-name{font-size:12px;font-weight:600;margin-bottom:2px}
.dept-status{font-size:10px}
.dept-toggle{width:40px;height:22px;border-radius:11px;cursor:pointer;border:none;position:relative;transition:all .3s}
.dept-toggle.on{background:var(--green)}
.dept-toggle.off{background:var(--bg4)}
.dept-toggle::after{content:'';position:absolute;width:16px;height:16px;border-radius:50%;background:#fff;top:3px;transition:left .3s}
.dept-toggle.on::after{left:21px}
.dept-toggle.off::after{left:3px}

/* TIMELINE */
.timeline-item{display:flex;gap:12px;padding:8px 0;border-bottom:1px solid var(--border)}
.timeline-dot{width:8px;height:8px;border-radius:50%;background:var(--violet);margin-top:5px;flex-shrink:0}
.timeline-text{font-size:12px;color:var(--text2)}
.timeline-text strong{color:var(--text);font-weight:500}
.timeline-time{font-size:10px;color:var(--text3);margin-top:2px}

/* EMPTY STATE */
.empty-state{text-align:center;padding:40px;color:var(--text3);font-size:13px}
.empty-state .icon{font-size:32px;margin-bottom:8px;display:block}

/* FILTER BAR */
.filter-bar{display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap;align-items:center}
.filter-bar select{padding:6px 10px;border-radius:6px;border:1px solid var(--border);background:var(--bg3);color:var(--text);font-size:12px}

/* TOAST */
.toast{position:fixed;bottom:24px;right:24px;background:var(--bg4);border:1px solid var(--border2);padding:12px 20px;border-radius:10px;font-size:13px;z-index:200;transform:translateY(100px);opacity:0;transition:all .3s}
.toast.show{transform:translateY(0);opacity:1}
.toast.success{border-color:rgba(16,185,129,0.4)}
.toast.error{border-color:rgba(239,68,68,0.4)}

/* CHAT CEO */
.chat-container{display:flex;height:calc(100vh - 140px);gap:0;border:1px solid var(--border);border-radius:12px;overflow:hidden;background:var(--bg2)}
.chat-list{width:280px;border-right:1px solid var(--border);display:flex;flex-direction:column;flex-shrink:0}
.chat-list-header{padding:16px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.chat-list-header h3{font-family:var(--font);font-size:14px;font-weight:600}
.chat-list-items{flex:1;overflow-y:auto}
.chat-contact{display:flex;align-items:center;gap:10px;padding:12px 16px;cursor:pointer;border-bottom:1px solid var(--border);transition:background .2s}
.chat-contact:hover,.chat-contact.active{background:var(--bg3)}
.chat-contact.active{border-left:3px solid var(--violet)}
.chat-avatar{width:36px;height:36px;border-radius:50%;background:var(--grad);display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:700;color:#fff;flex-shrink:0}
.chat-contact-info{flex:1;min-width:0}
.chat-contact-name{font-size:13px;font-weight:600;margin-bottom:2px}
.chat-contact-preview{font-size:11px;color:var(--text3);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.chat-contact-time{font-size:10px;color:var(--text3)}
.chat-contact-badge{background:var(--violet);color:#fff;font-size:9px;padding:2px 6px;border-radius:10px;font-weight:700}
.chat-window{flex:1;display:flex;flex-direction:column}
.chat-window-header{padding:12px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;background:var(--bg2)}
.chat-window-header .name{font-family:var(--font);font-size:14px;font-weight:600}
.chat-window-header .status{font-size:11px;color:var(--green)}
.chat-messages{flex:1;overflow-y:auto;padding:20px;display:flex;flex-direction:column;gap:4px;background:var(--bg)}
.chat-bubble-wrap{display:flex;flex-direction:column;max-width:70%}
.chat-bubble-wrap.enviado{align-self:flex-end;align-items:flex-end}
.chat-bubble-wrap.recibido{align-self:flex-start;align-items:flex-start}
.chat-bubble{padding:10px 14px;border-radius:12px;font-size:13px;line-height:1.4;word-wrap:break-word}
.chat-bubble.enviado{background:var(--violet);color:#fff;border-bottom-right-radius:4px}
.chat-bubble.recibido{background:var(--bg3);color:var(--text);border-bottom-left-radius:4px}
.chat-bubble-time{font-size:9px;color:var(--text3);margin-top:2px;padding:0 4px}
.chat-bubble-wrap.enviado .chat-bubble-time{text-align:right}
.chat-date-divider{text-align:center;padding:8px 0;font-size:10px;color:var(--text3)}
.chat-date-divider span{background:var(--bg3);padding:3px 12px;border-radius:10px}
.chat-input-bar{padding:12px 16px;border-top:1px solid var(--border);display:flex;gap:8px;align-items:center;background:var(--bg2)}
.chat-input-bar input{flex:1;padding:10px 16px;border:1px solid var(--border2);border-radius:20px;background:var(--bg3);color:var(--text);font-size:13px;font-family:var(--body);outline:none}
.chat-input-bar input:focus{border-color:var(--violet)}
.chat-input-bar input::placeholder{color:var(--text3)}
.chat-send-btn{width:38px;height:38px;border-radius:50%;background:var(--violet);border:none;color:#fff;font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:opacity .2s}
.chat-send-btn:hover{opacity:.85}
.chat-empty{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;color:var(--text3);font-size:14px;gap:8px}
.chat-suggestions{display:flex;flex-wrap:wrap;gap:6px;padding:8px 16px;border-top:1px solid var(--border);background:var(--bg2)}
.chat-suggestion{padding:6px 12px;border-radius:16px;border:1px solid var(--border2);background:var(--bg3);font-size:11px;color:var(--text2);cursor:pointer;transition:all .2s}
.chat-suggestion:hover{background:var(--violet);color:#fff;border-color:var(--violet)}
.cerebro-badge{display:inline-flex;align-items:center;gap:4px;padding:3px 8px;border-radius:8px;font-size:10px;font-weight:600;background:rgba(139,92,246,0.15);color:var(--violet)}
.chat-wa-status{display:flex;align-items:center;gap:6px;padding:8px 16px;font-size:11px;border-bottom:1px solid var(--border)}
.chat-wa-status .dot{width:8px;height:8px;border-radius:50%}
.chat-wa-status .dot.online{background:var(--green)}
.chat-wa-status .dot.offline{background:var(--red)}

/* MOBILE */
.menu-toggle{display:none;background:none;border:none;color:var(--text);font-size:24px;cursor:pointer}
@media(max-width:768px){
.sidebar{transform:translateX(-100%)}
.sidebar.open{transform:translateX(0)}
.main{margin-left:0}
.menu-toggle{display:block}
.kpi-grid{grid-template-columns:1fr 1fr}
.grid-2,.grid-3,.finance-summary{grid-template-columns:1fr}
.dept-grid{grid-template-columns:1fr 1fr}
.form-row{grid-template-columns:1fr}
.chat-container{flex-direction:column;height:auto}
.chat-list{width:100%;max-height:200px}
}
@media(max-width:480px){
.kpi-grid{grid-template-columns:1fr}
.dept-grid{grid-template-columns:1fr}
}
</style>
</head>
<body>

<!-- SIDEBAR -->
<aside class="sidebar" id="sidebar">
<div class="sidebar-logo">
<div class="logo-mark">D</div>
<div><span class="logo-text">DIVINIA</span><span class="logo-ver">OS v3.1</span></div>
</div>
<nav>
<div class="nav-label">Principal</div>
<div class="nav-item active" onclick="showSection('dashboard')"><span class="icon">üìä</span> Dashboard</div>
<div class="nav-item" onclick="showSection('clientes')"><span class="icon">üë•</span> CRM / Clientes</div>
<div class="nav-item" onclick="showSection('proyectos')"><span class="icon">üöÄ</span> Proyectos</div>
<div class="nav-item" onclick="showSection('agenda')"><span class="icon">üìã</span> Agenda de Joaco</div>
<div class="nav-label">Comunicaci√≥n</div>
<div class="nav-item" onclick="showSection('chat')"><span class="icon">üí¨</span> Chat CEO</div>
<div class="nav-label">Gesti√≥n</div>
<div class="nav-item" onclick="showSection('finanzas')"><span class="icon">üí∞</span> Finanzas</div>
<div class="nav-item" onclick="showSection('departamentos')"><span class="icon">üè¢</span> Departamentos</div>
<div class="nav-label">Recursos</div>
<div class="nav-item" onclick="showSection('catalogo')"><span class="icon">üì¶</span> Cat√°logo</div>
</nav>
<div class="sidebar-footer">DIVINIA ¬© 2026 ‚Äî San Luis, Argentina</div>
</aside>

<!-- MAIN -->
<div class="main">
<div class="topbar">
<div style="display:flex;align-items:center;gap:12px">
<button class="menu-toggle" onclick="document.getElementById('sidebar').classList.toggle('open')">‚ò∞</button>
<h1 id="page-title">Dashboard</h1>
</div>
<div class="topbar-right">
<span class="topbar-date" id="topbar-date"></span>
<div class="topbar-user">üë§ Joaco ‚Äî CEO</div>
</div>
</div>
<div class="content">

<!-- ====== DASHBOARD ====== -->
<div class="section active" id="sec-dashboard">
<div class="kpi-grid" id="kpi-grid"></div>
<div class="grid-2">
<div class="card">
<div class="card-header"><span class="card-title">Proyectos Activos</span></div>
<div id="dash-projects"></div>
</div>
<div class="card">
<div class="card-header"><span class="card-title">Actividad Reciente</span></div>
<div id="dash-timeline"></div>
</div>
</div>
<div class="card">
<div class="card-header"><span class="card-title">Acciones R√°pidas</span></div>
<div style="display:flex;gap:8px;flex-wrap:wrap">
<button class="btn btn-primary" onclick="openModal('cliente')">+ Nuevo Cliente</button>
<button class="btn btn-primary" onclick="openModal('proyecto')">+ Nuevo Proyecto</button>
<button class="btn" onclick="openModal('tarea')">+ Tarea para Joaco</button>
<button class="btn" onclick="openModal('movimiento')">+ Registrar Pago</button>
</div>
</div>
</div>

<!-- ====== CRM / CLIENTES ====== -->
<div class="section" id="sec-clientes">
<div class="filter-bar">
<button class="btn btn-primary" onclick="openModal('cliente')">+ Nuevo Cliente</button>
<select id="filter-estado-cliente" onchange="renderClientes()">
<option value="">Todos los estados</option>
<option value="nuevo">Nuevo</option>
<option value="contactado">Contactado</option>
<option value="propuesta">Propuesta</option>
<option value="negociacion">Negociaci√≥n</option>
<option value="cerrado">Cerrado</option>
<option value="activo">Activo</option>
</select>
<select id="filter-rubro" onchange="renderClientes()">
<option value="">Todos los rubros</option>
</select>
</div>
<div class="card">
<div class="table-wrap">
<table>
<thead><tr><th>Cliente</th><th>Empresa</th><th>Rubro</th><th>Estado</th><th>Score</th><th>Contacto</th><th>Acciones</th></tr></thead>
<tbody id="clientes-table"></tbody>
</table>
</div>
</div>
</div>

<!-- ====== PROYECTOS ====== -->
<div class="section" id="sec-proyectos">
<div class="filter-bar">
<button class="btn btn-primary" onclick="openModal('proyecto')">+ Nuevo Proyecto</button>
<select id="filter-estado-proyecto" onchange="renderProyectos()">
<option value="">Todos los estados</option>
<option value="propuesta">Propuesta</option>
<option value="aprobado">Aprobado</option>
<option value="en_desarrollo">En Desarrollo</option>
<option value="revision">Revisi√≥n</option>
<option value="entregado">Entregado</option>
<option value="soporte">Soporte</option>
</select>
</div>
<div id="proyectos-list"></div>
</div>

<!-- ====== AGENDA ====== -->
<div class="section" id="sec-agenda">
<div class="filter-bar">
<button class="btn btn-primary" onclick="openModal('tarea')">+ Nueva Tarea</button>
<button class="btn btn-sm" onclick="filterTareas('todas')">Todas</button>
<button class="btn btn-sm" onclick="filterTareas('pendientes')">Pendientes</button>
<button class="btn btn-sm" onclick="filterTareas('completadas')">Completadas</button>
</div>
<div class="grid-2">
<div class="card">
<div class="card-header"><span class="card-title">üìÖ Tareas de Hoy</span></div>
<div id="tareas-hoy"></div>
</div>
<div class="card">
<div class="card-header"><span class="card-title">üìå Pendientes Generales</span></div>
<div id="tareas-pendientes"></div>
</div>
</div>
</div>

<!-- ====== CHAT CEO ====== -->
<div class="section" id="sec-chat">
<div class="chat-wa-status" id="chat-wa-status">
<span class="dot offline"></span>
<span>WhatsApp: Desconectado ‚Äî <a href="#" onclick="showSupabaseConfig()" style="color:var(--violet)">Configurar Supabase + WhatsApp</a></span>
<span style="margin-left:auto" class="cerebro-badge">üß† Cerebro v1</span>
</div>
<div class="chat-container">
<div class="chat-list">
<div class="chat-list-header">
<h3>Conversaciones</h3>
<button class="btn btn-sm btn-primary" onclick="openModal('nueva-conversacion')">+</button>
</div>
<div class="chat-list-items" id="chat-conversations"></div>
</div>
<div class="chat-window" id="chat-window">
<div class="chat-empty" id="chat-empty">
<span style="font-size:48px">üí¨</span>
<span>Seleccion√° una conversaci√≥n</span>
<span style="font-size:12px">o cre√° una nueva para empezar</span>
</div>
<div style="display:none;flex-direction:column;height:100%" id="chat-active">
<div class="chat-window-header">
<div>
<div class="name" id="chat-contact-name">‚Äî</div>
<div class="status" id="chat-contact-status">‚Äî</div>
</div>
<div style="display:flex;gap:6px">
<button class="btn btn-sm" onclick="vincularClienteChat()">üîó Vincular</button>
<button class="btn btn-sm" onclick="openWhatsAppDirect()">üì± Abrir WA</button>
</div>
</div>
<div class="chat-messages" id="chat-messages"></div>
<div class="chat-suggestions" id="chat-suggestions" style="display:none"></div>
<div class="chat-input-bar">
<input type="text" id="chat-input" placeholder="Escribir mensaje..." onkeypress="if(event.key==='Enter')sendMessage()">
<button class="chat-send-btn" onclick="sendMessage()">‚û§</button>
</div>
</div>
</div>
</div>
</div>

<!-- ====== FINANZAS ====== -->
<div class="section" id="sec-finanzas">
<div class="finance-summary" id="finance-summary"></div>
<div class="filter-bar">
<button class="btn btn-primary" onclick="openModal('movimiento')">+ Nuevo Movimiento</button>
</div>
<div class="card">
<div class="table-wrap">
<table>
<thead><tr><th>Fecha</th><th>Tipo</th><th>Concepto</th><th>Cliente</th><th>Monto</th><th>Acciones</th></tr></thead>
<tbody id="finanzas-table"></tbody>
</table>
</div>
</div>
</div>

<!-- ====== DEPARTAMENTOS ====== -->
<div class="section" id="sec-departamentos">
<div class="dept-grid" id="dept-grid"></div>
</div>

<!-- ====== CAT√ÅLOGO ====== -->
<div class="section" id="sec-catalogo">
<div class="grid-3" id="catalogo-grid"></div>
</div>

</div><!-- content -->
</div><!-- main -->

<!-- MODAL -->
<div class="modal-overlay" id="modal-overlay" onclick="if(event.target===this)closeModal()">
<div class="modal" id="modal-content"></div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<script>
// ============================================================
// DATA LAYER ‚Äî localStorage persistence
// ============================================================
const DB_KEY = 'divinia_os_v3';

function loadDB() {
  const raw = localStorage.getItem(DB_KEY);
  if (raw) return JSON.parse(raw);
  return getDefaultData();
}

function saveDB(db) {
  localStorage.setItem(DB_KEY, JSON.stringify(db));
}

function getDefaultData() {
  return {
    clientes: [
      { id: 1, nombre: "Ediro", empresa: "Secretar√≠a de Transporte ‚Äî Gob. de San Luis", rubro: "Gobierno", telefono: "", email: "", estado: "activo", score: 95, fechaAlta: "2026-02-17", notas: "Primer cliente. Contacto directo. M√∫ltiples proyectos potenciales." }
    ],
    proyectos: [
      { id: 1, clienteId: 1, nombre: "TUBI ‚Äî WebApp Bicicletas P√∫blicas", servicio: "Web App Completa", precio: 500000, estado: "en_desarrollo", progreso: 60, deadline: "2026-03-15", notas: "PHP + Gemini AI. 5 roles (admin, alumno, escuela, proveedor, tutor). Gamificaci√≥n. Falta: DB real, auth persistente, exports." }
    ],
    tareas: [
      { id: 1, texto: "Revisar avance de TUBI con Ediro", prioridad: "alta", categoria: "reuni√≥n", fecha: "2026-02-18", done: false },
      { id: 2, texto: "Configurar monotributo en AFIP para DIVINIA", prioridad: "alta", categoria: "tr√°mite", fecha: "2026-02-19", done: false },
      { id: 3, texto: "Publicar landing de DIVINIA en redes sociales", prioridad: "media", categoria: "aprobaci√≥n", fecha: "2026-02-18", done: false },
      { id: 4, texto: "Buscar 10 leads nuevos en Google Maps San Luis", prioridad: "media", categoria: "llamada", fecha: "2026-02-18", done: false },
      { id: 5, texto: "Testear landing en mobile y corregir bugs", prioridad: "baja", categoria: "deploy", fecha: "2026-02-17", done: true }
    ],
    movimientos: [
      { id: 1, tipo: "gasto", concepto: "Claude API ‚Äî Anthropic", monto: 20, moneda: "USD", clienteId: null, fecha: "2026-02-17" }
    ],
    departamentos: [
      { id: 1, nombre: "IA & Automatizaciones", icono: "ü§ñ", activo: true },
      { id: 2, nombre: "Web & Apps", icono: "üíª", activo: true },
      { id: 3, nombre: "YouTube & Multimedia", icono: "üé¨", activo: false },
      { id: 4, nombre: "Content Factory", icono: "üìù", activo: false },
      { id: 5, nombre: "Clientes & Servicios", icono: "ü§ù", activo: true },
      { id: 6, nombre: "Avatares IA", icono: "üßë‚Äçüíº", activo: false },
      { id: 7, nombre: "Legal & Compliance", icono: "‚öñÔ∏è", activo: false },
      { id: 8, nombre: "Ciberseguridad", icono: "üîí", activo: false },
      { id: 9, nombre: "Contabilidad & Finanzas", icono: "üìä", activo: true },
      { id: 10, nombre: "RRHH Digital", icono: "üë•", activo: false },
      { id: 11, nombre: "Innovaci√≥n", icono: "üí°", activo: false }
    ],
    timeline: [
      { texto: "DIVINIA OS v3.0 activado", fecha: "2026-02-17 10:00" },
      { texto: "Landing page desplegada en Vercel", fecha: "2026-02-17 11:00" },
      { texto: "WhatsApp corregido en GitHub", fecha: "2026-02-17 15:00" },
      { texto: "Cliente <strong>Ediro</strong> registrado ‚Äî Secretar√≠a de Transporte", fecha: "2026-02-17 16:00" },
      { texto: "Proyecto <strong>TUBI</strong> registrado ‚Äî en desarrollo", fecha: "2026-02-17 16:00" }
    ],
    nextId: { clientes: 2, proyectos: 2, tareas: 6, movimientos: 2 }
  };
}

let DB = loadDB();

// ============================================================
// NAVIGATION
// ============================================================
const titles = {
  dashboard: "Dashboard",
  clientes: "CRM / Clientes",
  proyectos: "Proyectos",
  agenda: "Agenda de Joaco",
  finanzas: "Finanzas",
  departamentos: "Departamentos",
  catalogo: "Cat√°logo de Servicios",
  chat: "Chat CEO"
};

function showSection(id) {
  document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  document.getElementById('sec-' + id).classList.add('active');
  document.getElementById('page-title').textContent = titles[id] || id;
  // Mark nav active
  document.querySelectorAll('.nav-item').forEach(n => {
    if (n.textContent.trim().includes(titles[id]?.split('/')[0]?.trim() || '---')) n.classList.add('active');
  });
  // Re-render section
  const renders = { dashboard: renderDashboard, clientes: renderClientes, proyectos: renderProyectos, agenda: renderAgenda, chat: renderChat, finanzas: renderFinanzas, departamentos: renderDepartamentos, catalogo: renderCatalogo };
  if (renders[id]) renders[id]();
  // Close mobile sidebar
  document.getElementById('sidebar').classList.remove('open');
}

// ============================================================
// DASHBOARD
// ============================================================
function renderDashboard() {
  const ingresos = DB.movimientos.filter(m => m.tipo === 'ingreso').reduce((s, m) => s + m.monto, 0);
  const proyActivos = DB.proyectos.filter(p => ['en_desarrollo','revision','aprobado'].includes(p.estado)).length;
  const leadsCount = DB.clientes.filter(c => ['nuevo','contactado','propuesta','negociacion'].includes(c.estado)).length;
  const tareasPend = DB.tareas.filter(t => !t.done).length;

  document.getElementById('kpi-grid').innerHTML = `
    <div class="kpi-card highlight"><div class="kpi-label">Ingresos del Mes</div><div class="kpi-value" style="background:var(--grad);-webkit-background-clip:text;-webkit-text-fill-color:transparent">$${formatMoney(ingresos)}</div><div class="kpi-sub">ARS ‚Äî Febrero 2026</div></div>
    <div class="kpi-card"><div class="kpi-label">Proyectos Activos</div><div class="kpi-value">${proyActivos}</div><div class="kpi-sub">${DB.proyectos.length} totales</div></div>
    <div class="kpi-card"><div class="kpi-label">Leads en Pipeline</div><div class="kpi-value">${leadsCount}</div><div class="kpi-sub">${DB.clientes.length} clientes totales</div></div>
    <div class="kpi-card"><div class="kpi-label">Tareas Pendientes</div><div class="kpi-value">${tareasPend}</div><div class="kpi-sub">${DB.tareas.filter(t=>t.done).length} completadas</div></div>
  `;

  // Active projects
  const activeP = DB.proyectos.filter(p => p.estado !== 'entregado').slice(0, 5);
  document.getElementById('dash-projects').innerHTML = activeP.length ? activeP.map(p => {
    const cli = DB.clientes.find(c => c.id === p.clienteId);
    return `<div style="padding:10px 0;border-bottom:1px solid var(--border)">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><strong style="font-size:13px">${p.nombre}</strong><div style="font-size:11px;color:var(--text3)">${cli ? cli.empresa : 'Sin cliente'} ‚Äî ${formatMoney(p.precio)} ARS</div></div>
        <span class="badge badge-${p.estado}">${p.estado.replace('_',' ')}</span>
      </div>
      <div class="progress-bar" style="margin-top:8px"><div class="progress-fill" style="width:${p.progreso}%"></div></div>
      <div style="font-size:10px;color:var(--text3);margin-top:4px">${p.progreso}% completado ‚Äî Deadline: ${p.deadline}</div>
    </div>`;
  }).join('') : '<div class="empty-state"><span class="icon">üöÄ</span>No hay proyectos activos</div>';

  // Timeline
  document.getElementById('dash-timeline').innerHTML = DB.timeline.slice(-8).reverse().map(t => `
    <div class="timeline-item"><div class="timeline-dot"></div><div><div class="timeline-text">${t.texto}</div><div class="timeline-time">${t.fecha}</div></div></div>
  `).join('');
}

// ============================================================
// CRM / CLIENTES
// ============================================================
function renderClientes() {
  const estadoF = document.getElementById('filter-estado-cliente').value;
  const rubroF = document.getElementById('filter-rubro').value;
  let list = DB.clientes;
  if (estadoF) list = list.filter(c => c.estado === estadoF);
  if (rubroF) list = list.filter(c => c.rubro === rubroF);
  // Update rubro filter options
  const rubros = [...new Set(DB.clientes.map(c => c.rubro))];
  const rubroSel = document.getElementById('filter-rubro');
  const currentRubro = rubroSel.value;
  rubroSel.innerHTML = '<option value="">Todos los rubros</option>' + rubros.map(r => `<option value="${r}" ${r===currentRubro?'selected':''}>${r}</option>`).join('');

  document.getElementById('clientes-table').innerHTML = list.length ? list.map(c => {
    const scoreColor = c.score >= 80 ? 'var(--green)' : c.score >= 50 ? 'var(--yellow)' : 'var(--red)';
    return `<tr>
      <td><strong>${c.nombre}</strong></td>
      <td style="font-size:12px">${c.empresa}</td>
      <td><span class="badge badge-propuesta">${c.rubro}</span></td>
      <td><span class="badge badge-${c.estado}">${c.estado}</span></td>
      <td><div class="score-bar"><div class="score-fill" style="width:${c.score}%;background:${scoreColor}"></div></div>${c.score}</td>
      <td style="font-size:12px">${c.telefono || c.email || '‚Äî'}</td>
      <td><button class="btn btn-sm" onclick="editCliente(${c.id})">‚úèÔ∏è</button> <button class="btn btn-sm btn-danger" onclick="deleteCliente(${c.id})">üóë</button></td>
    </tr>`;
  }).join('') : '<tr><td colspan="7" class="empty-state"><span class="icon">üë•</span>No hay clientes. ¬°Agreg√° el primero!</td></tr>';
}

function editCliente(id) { openModal('cliente', id); }
function deleteCliente(id) {
  if (!confirm('¬øEliminar este cliente?')) return;
  DB.clientes = DB.clientes.filter(c => c.id !== id);
  saveDB(DB); renderClientes(); toast('Cliente eliminado','success');
}

// ============================================================
// PROYECTOS
// ============================================================
function renderProyectos() {
  const estadoF = document.getElementById('filter-estado-proyecto').value;
  let list = DB.proyectos;
  if (estadoF) list = list.filter(p => p.estado === estadoF);

  document.getElementById('proyectos-list').innerHTML = list.length ? list.map(p => {
    const cli = DB.clientes.find(c => c.id === p.clienteId);
    return `<div class="card" style="margin-bottom:16px">
      <div class="card-header">
        <div>
          <span class="card-title">${p.nombre}</span>
          <div style="font-size:12px;color:var(--text2);margin-top:2px">${cli ? cli.empresa : 'Sin cliente'}</div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <span class="badge badge-${p.estado}">${p.estado.replace('_',' ')}</span>
          <button class="btn btn-sm" onclick="editProyecto(${p.id})">‚úèÔ∏è</button>
          <button class="btn btn-sm btn-danger" onclick="deleteProyecto(${p.id})">üóë</button>
        </div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px;margin-bottom:12px">
        <div><div style="font-size:10px;color:var(--text3);text-transform:uppercase">Servicio</div><div style="font-size:13px">${p.servicio}</div></div>
        <div><div style="font-size:10px;color:var(--text3);text-transform:uppercase">Precio</div><div style="font-size:13px;font-weight:600">$${formatMoney(p.precio)} ARS</div></div>
        <div><div style="font-size:10px;color:var(--text3);text-transform:uppercase">Deadline</div><div style="font-size:13px">${p.deadline}</div></div>
      </div>
      <div class="progress-bar"><div class="progress-fill" style="width:${p.progreso}%"></div></div>
      <div style="display:flex;justify-content:space-between;margin-top:6px"><span style="font-size:11px;color:var(--text3)">${p.progreso}% completado</span></div>
      ${p.notas ? `<div style="margin-top:10px;padding:10px;background:var(--bg3);border-radius:8px;font-size:12px;color:var(--text2)">${p.notas}</div>` : ''}
    </div>`;
  }).join('') : '<div class="empty-state"><span class="icon">üöÄ</span>No hay proyectos. ¬°Cre√° el primero!</div>';
}

function editProyecto(id) { openModal('proyecto', id); }
function deleteProyecto(id) {
  if (!confirm('¬øEliminar este proyecto?')) return;
  DB.proyectos = DB.proyectos.filter(p => p.id !== id);
  saveDB(DB); renderProyectos(); toast('Proyecto eliminado','success');
}

// ============================================================
// AGENDA
// ============================================================
let tareaFilter = 'todas';
function filterTareas(f) { tareaFilter = f; renderAgenda(); }

function renderAgenda() {
  const hoy = new Date().toISOString().split('T')[0];
  let tareasHoy = DB.tareas.filter(t => t.fecha === hoy);
  let tareasPend = DB.tareas.filter(t => t.fecha !== hoy);
  if (tareaFilter === 'pendientes') { tareasHoy = tareasHoy.filter(t=>!t.done); tareasPend = tareasPend.filter(t=>!t.done); }
  if (tareaFilter === 'completadas') { tareasHoy = tareasHoy.filter(t=>t.done); tareasPend = tareasPend.filter(t=>t.done); }

  document.getElementById('tareas-hoy').innerHTML = tareasHoy.length ? tareasHoy.map(renderTarea).join('') : '<div class="empty-state"><span class="icon">‚úÖ</span>No hay tareas para hoy</div>';
  document.getElementById('tareas-pendientes').innerHTML = tareasPend.length ? tareasPend.map(renderTarea).join('') : '<div class="empty-state"><span class="icon">üìå</span>Sin tareas pendientes</div>';
}

function renderTarea(t) {
  return `<div class="task-item ${t.done?'done':''}">
    <div class="task-check" onclick="toggleTarea(${t.id})"></div>
    <div class="priority-dot priority-${t.prioridad}"></div>
    <div style="flex:1">
      <div class="task-text">${t.texto}</div>
      <div class="task-meta"><span>${t.categoria}</span><span>${t.fecha}</span></div>
    </div>
    <span class="task-delete" onclick="deleteTarea(${t.id})">‚úï</span>
  </div>`;
}

function toggleTarea(id) {
  const t = DB.tareas.find(t => t.id === id);
  if (t) { t.done = !t.done; saveDB(DB); renderAgenda(); addTimeline(t.done ? `Tarea completada: <strong>${t.texto}</strong>` : `Tarea reabierta: <strong>${t.texto}</strong>`); }
}

function deleteTarea(id) {
  DB.tareas = DB.tareas.filter(t => t.id !== id);
  saveDB(DB); renderAgenda(); toast('Tarea eliminada','success');
}

// ============================================================
// FINANZAS
// ============================================================
function renderFinanzas() {
  const ingresos = DB.movimientos.filter(m => m.tipo === 'ingreso').reduce((s, m) => s + m.monto, 0);
  const gastos = DB.movimientos.filter(m => m.tipo === 'gasto').reduce((s, m) => s + m.monto, 0);

  document.getElementById('finance-summary').innerHTML = `
    <div class="finance-card ingresos"><div class="finance-label">Ingresos</div><div class="finance-amount" style="color:var(--green)">$${formatMoney(ingresos)}</div><div style="font-size:11px;color:var(--text3)">ARS ‚Äî Febrero 2026</div></div>
    <div class="finance-card gastos"><div class="finance-label">Gastos</div><div class="finance-amount" style="color:var(--red)">$${formatMoney(gastos)}</div><div style="font-size:11px;color:var(--text3)">Suscripciones + APIs</div></div>
    <div class="finance-card balance"><div class="finance-label">Balance</div><div class="finance-amount" style="color:${ingresos-gastos>=0?'var(--cyan)':'var(--red)'}">$${formatMoney(ingresos - gastos)}</div><div style="font-size:11px;color:var(--text3)">Resultado del mes</div></div>
  `;

  document.getElementById('finanzas-table').innerHTML = DB.movimientos.length ? DB.movimientos.sort((a,b) => b.fecha.localeCompare(a.fecha)).map(m => {
    const cli = m.clienteId ? DB.clientes.find(c => c.id === m.clienteId) : null;
    return `<tr>
      <td>${m.fecha}</td>
      <td><span class="badge ${m.tipo==='ingreso'?'badge-activo':'badge-nuevo'}">${m.tipo}</span></td>
      <td>${m.concepto}</td>
      <td>${cli ? cli.nombre : '‚Äî'}</td>
      <td style="font-weight:600;color:${m.tipo==='ingreso'?'var(--green)':'var(--red)'}">${m.tipo==='ingreso'?'+':'-'}$${formatMoney(m.monto)} ${m.moneda||'ARS'}</td>
      <td><button class="btn btn-sm btn-danger" onclick="deleteMovimiento(${m.id})">üóë</button></td>
    </tr>`;
  }).join('') : '<tr><td colspan="6" class="empty-state">No hay movimientos registrados</td></tr>';
}

function deleteMovimiento(id) {
  DB.movimientos = DB.movimientos.filter(m => m.id !== id);
  saveDB(DB); renderFinanzas(); toast('Movimiento eliminado','success');
}

// ============================================================
// DEPARTAMENTOS
// ============================================================
function renderDepartamentos() {
  document.getElementById('dept-grid').innerHTML = DB.departamentos.map(d => `
    <div class="dept-card">
      <div class="dept-icon">${d.icono}</div>
      <div class="dept-info">
        <div class="dept-name">${d.nombre}</div>
        <div class="dept-status" style="color:${d.activo?'var(--green)':'var(--text3)'}">${d.activo ? '‚óè Activo' : '‚óã Standby'}</div>
      </div>
      <button class="dept-toggle ${d.activo?'on':'off'}" onclick="toggleDept(${d.id})"></button>
    </div>
  `).join('');
}

function toggleDept(id) {
  const d = DB.departamentos.find(d => d.id === id);
  if (d) { d.activo = !d.activo; saveDB(DB); renderDepartamentos(); toast(`${d.nombre}: ${d.activo?'Activado':'Desactivado'}`, 'success'); }
}

// ============================================================
// CAT√ÅLOGO
// ============================================================
function renderCatalogo() {
  const servicios = [
    { cat: "IA & Automatizaciones", items: [
      { nombre: "Chatbot WhatsApp b√°sico", precio: 150000, tiempo: "48hs" },
      { nombre: "Chatbot WhatsApp pro", precio: 250000, tiempo: "1 semana" },
      { nombre: "Automatizaci√≥n de proceso", precio: 120000, tiempo: "2-3 d√≠as" },
      { nombre: "Pack 3 automatizaciones", precio: 300000, tiempo: "1 semana" },
      { nombre: "CRM automatizado con IA", precio: 400000, tiempo: "2 semanas" },
      { nombre: "Sistema multi-agente", precio: 800000, tiempo: "2-4 semanas" }
    ]},
    { cat: "Web & Apps", items: [
      { nombre: "Landing page", precio: 100000, tiempo: "24-48hs" },
      { nombre: "Sitio web completo", precio: 300000, tiempo: "1-2 semanas" },
      { nombre: "Dashboard / Panel admin", precio: 400000, tiempo: "2-3 semanas" },
      { nombre: "App m√≥vil", precio: 500000, tiempo: "3-4 semanas" }
    ]},
    { cat: "Avatares IA", items: [
      { nombre: "Avatar corporativo", precio: 200000, tiempo: "1 semana" },
      { nombre: "Avatar atenci√≥n al cliente", precio: 150000, tiempo: "1 semana" },
      { nombre: "Influencer / presentador IA", precio: 300000, tiempo: "2 semanas" },
      { nombre: "Pack 10 videos con avatar", precio: 100000, tiempo: "1 semana" }
    ]},
    { cat: "Content Factory", items: [
      { nombre: "Pack 30 posts/mes", precio: 80000, tiempo: "Mensual" },
      { nombre: "Pack 10 posts + 4 videos", precio: 120000, tiempo: "Mensual" },
      { nombre: "Gesti√≥n completa redes", precio: 150000, tiempo: "Mensual" }
    ]},
    { cat: "YouTube", items: [
      { nombre: "Gui√≥n + producci√≥n 1 video", precio: 50000, tiempo: "3-5 d√≠as" },
      { nombre: "Pack 4 videos/mes", precio: 150000, tiempo: "Mensual" },
      { nombre: "Canal completo (10 videos)", precio: 400000, tiempo: "1 mes" }
    ]},
    { cat: "Mantenimiento", items: [
      { nombre: "Plan b√°sico", precio: 50000, tiempo: "Mensual" },
      { nombre: "Plan pro", precio: 100000, tiempo: "Mensual" },
      { nombre: "Plan enterprise", precio: 200000, tiempo: "Mensual" }
    ]}
  ];

  document.getElementById('catalogo-grid').innerHTML = servicios.map(s => `
    <div class="card">
      <div class="card-title" style="margin-bottom:12px">${s.cat}</div>
      ${s.items.map(i => `
        <div style="display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid var(--border)">
          <div style="font-size:12px">${i.nombre}</div>
          <div style="text-align:right"><div style="font-size:13px;font-weight:600;color:var(--cyan)">$${formatMoney(i.precio)}</div><div style="font-size:10px;color:var(--text3)">${i.tiempo}</div></div>
        </div>
      `).join('')}
    </div>
  `).join('');
}

// ============================================================
// MODALS
// ============================================================
function openModal(type, editId) {
  const m = document.getElementById('modal-content');
  let html = '';

  if (type === 'cliente') {
    const c = editId ? DB.clientes.find(x => x.id === editId) : null;
    html = `<h2>${c ? 'Editar' : 'Nuevo'} Cliente</h2>
    <div class="form-row"><div class="form-group"><label>Nombre</label><input id="f-cli-nombre" value="${c?.nombre||''}"></div><div class="form-group"><label>Empresa</label><input id="f-cli-empresa" value="${c?.empresa||''}"></div></div>
    <div class="form-row"><div class="form-group"><label>Rubro</label><input id="f-cli-rubro" value="${c?.rubro||''}" placeholder="Ej: Gastronom√≠a, Gobierno..."></div><div class="form-group"><label>Estado</label><select id="f-cli-estado"><option value="nuevo" ${c?.estado==='nuevo'?'selected':''}>Nuevo</option><option value="contactado" ${c?.estado==='contactado'?'selected':''}>Contactado</option><option value="propuesta" ${c?.estado==='propuesta'?'selected':''}>Propuesta</option><option value="negociacion" ${c?.estado==='negociacion'?'selected':''}>Negociaci√≥n</option><option value="cerrado" ${c?.estado==='cerrado'?'selected':''}>Cerrado</option><option value="activo" ${c?.estado==='activo'?'selected':''}>Activo</option></select></div></div>
    <div class="form-row"><div class="form-group"><label>Tel√©fono</label><input id="f-cli-tel" value="${c?.telefono||''}"></div><div class="form-group"><label>Email</label><input id="f-cli-email" value="${c?.email||''}"></div></div>
    <div class="form-row"><div class="form-group"><label>Score (0-100)</label><input id="f-cli-score" type="number" min="0" max="100" value="${c?.score||50}"></div><div class="form-group"><label>Fecha Alta</label><input id="f-cli-fecha" type="date" value="${c?.fechaAlta||new Date().toISOString().split('T')[0]}"></div></div>
    <div class="form-group"><label>Notas</label><textarea id="f-cli-notas">${c?.notas||''}</textarea></div>
    <div class="form-actions"><button class="btn" onclick="closeModal()">Cancelar</button><button class="btn btn-primary" onclick="saveCliente(${editId||0})">Guardar</button></div>`;
  }

  if (type === 'proyecto') {
    const p = editId ? DB.proyectos.find(x => x.id === editId) : null;
    const cliOptions = DB.clientes.map(c => `<option value="${c.id}" ${p?.clienteId===c.id?'selected':''}>${c.nombre} ‚Äî ${c.empresa}</option>`).join('');
    html = `<h2>${p ? 'Editar' : 'Nuevo'} Proyecto</h2>
    <div class="form-group"><label>Nombre del Proyecto</label><input id="f-proy-nombre" value="${p?.nombre||''}"></div>
    <div class="form-row"><div class="form-group"><label>Cliente</label><select id="f-proy-cliente"><option value="">Seleccionar...</option>${cliOptions}</select></div><div class="form-group"><label>Servicio</label><input id="f-proy-servicio" value="${p?.servicio||''}" placeholder="Ej: Web App Completa"></div></div>
    <div class="form-row"><div class="form-group"><label>Precio (ARS)</label><input id="f-proy-precio" type="number" value="${p?.precio||0}"></div><div class="form-group"><label>Deadline</label><input id="f-proy-deadline" type="date" value="${p?.deadline||''}"></div></div>
    <div class="form-row"><div class="form-group"><label>Estado</label><select id="f-proy-estado"><option value="propuesta" ${p?.estado==='propuesta'?'selected':''}>Propuesta</option><option value="aprobado" ${p?.estado==='aprobado'?'selected':''}>Aprobado</option><option value="en_desarrollo" ${p?.estado==='en_desarrollo'?'selected':''}>En Desarrollo</option><option value="revision" ${p?.estado==='revision'?'selected':''}>Revisi√≥n</option><option value="entregado" ${p?.estado==='entregado'?'selected':''}>Entregado</option><option value="soporte" ${p?.estado==='soporte'?'selected':''}>Soporte</option></select></div><div class="form-group"><label>Progreso (%)</label><input id="f-proy-progreso" type="number" min="0" max="100" value="${p?.progreso||0}"></div></div>
    <div class="form-group"><label>Notas</label><textarea id="f-proy-notas">${p?.notas||''}</textarea></div>
    <div class="form-actions"><button class="btn" onclick="closeModal()">Cancelar</button><button class="btn btn-primary" onclick="saveProyecto(${editId||0})">Guardar</button></div>`;
  }

  if (type === 'tarea') {
    html = `<h2>Nueva Tarea</h2>
    <div class="form-group"><label>Descripci√≥n</label><input id="f-tarea-texto" placeholder="¬øQu√© tiene que hacer Joaco?"></div>
    <div class="form-row"><div class="form-group"><label>Prioridad</label><select id="f-tarea-prioridad"><option value="alta">üî¥ Alta</option><option value="media" selected>üü° Media</option><option value="baja">‚ö™ Baja</option></select></div><div class="form-group"><label>Categor√≠a</label><select id="f-tarea-cat"><option value="reuni√≥n">Reuni√≥n</option><option value="tr√°mite">Tr√°mite</option><option value="aprobaci√≥n">Aprobaci√≥n</option><option value="llamada">Llamada</option><option value="deploy">Deploy</option></select></div></div>
    <div class="form-group"><label>Fecha</label><input id="f-tarea-fecha" type="date" value="${new Date().toISOString().split('T')[0]}"></div>
    <div class="form-actions"><button class="btn" onclick="closeModal()">Cancelar</button><button class="btn btn-primary" onclick="saveTarea()">Guardar</button></div>`;
  }

  if (type === 'movimiento') {
    const cliOptions = DB.clientes.map(c => `<option value="${c.id}">${c.nombre}</option>`).join('');
    html = `<h2>Nuevo Movimiento</h2>
    <div class="form-row"><div class="form-group"><label>Tipo</label><select id="f-mov-tipo"><option value="ingreso">Ingreso</option><option value="gasto">Gasto</option></select></div><div class="form-group"><label>Monto</label><input id="f-mov-monto" type="number" value="0"></div></div>
    <div class="form-row"><div class="form-group"><label>Concepto</label><input id="f-mov-concepto" placeholder="Ej: Pago adelanto TUBI"></div><div class="form-group"><label>Cliente (opcional)</label><select id="f-mov-cliente"><option value="">Ninguno</option>${cliOptions}</select></div></div>
    <div class="form-row"><div class="form-group"><label>Moneda</label><select id="f-mov-moneda"><option value="ARS">ARS</option><option value="USD">USD</option></select></div><div class="form-group"><label>Fecha</label><input id="f-mov-fecha" type="date" value="${new Date().toISOString().split('T')[0]}"></div></div>
    <div class="form-actions"><button class="btn" onclick="closeModal()">Cancelar</button><button class="btn btn-primary" onclick="saveMovimiento()">Guardar</button></div>`;
  }

  if (type === 'nueva-conversacion') {
    html = `<h2>üí¨ Nueva Conversaci√≥n</h2>
    <div class="form-group"><label>Nombre del Contacto</label><input id="f-chat-nombre" placeholder="Ej: Juan P√©rez"></div>
    <div class="form-group"><label>Tel√©fono (con c√≥digo pa√≠s, sin +)</label><input id="f-chat-tel" placeholder="Ej: 542665123456"></div>
    <div class="form-group"><label>Vincular a cliente (opcional)</label><select id="f-chat-cliente"><option value="">Sin vincular</option>${DB.clientes.map(c=>`<option value="${c.id}">${c.nombre} ‚Äî ${c.empresa}</option>`).join('')}</select></div>
    <div class="form-actions"><button class="btn" onclick="closeModal()">Cancelar</button><button class="btn btn-primary" onclick="saveNuevaConversacion()">Crear</button></div>`;
  }

  m.innerHTML = html;
  document.getElementById('modal-overlay').classList.add('show');
}

function saveNuevaConversacion() {
  const nombre = document.getElementById('f-chat-nombre').value.trim();
  const tel = document.getElementById('f-chat-tel').value.trim().replace(/[^0-9]/g,'');
  const cliId = parseInt(document.getElementById('f-chat-cliente').value) || null;
  if (!nombre || !tel) { toast('Nombre y tel√©fono son obligatorios','error'); return; }
  if (chatConversaciones.find(c => c.telefono === tel)) { toast('Ya existe una conversaci√≥n con ese n√∫mero','error'); return; }
  chatConversaciones.push({
    id: chatConversaciones.length + 1,
    telefono: tel, nombre, clienteId: cliId,
    ultimoMsg: '', ultimoTime: '', unread: 0
  });
  chatMensajes[tel] = [];
  saveChat();
  closeModal();
  openChat(tel);
  renderConversaciones();
  addTimeline(`Chat: nueva conversaci√≥n con <strong>${nombre}</strong>`);
  toast('Conversaci√≥n creada','success');
}

function closeModal() { document.getElementById('modal-overlay').classList.remove('show'); }

// ============================================================
// SAVE FUNCTIONS
// ============================================================
function saveCliente(editId) {
  const data = {
    nombre: document.getElementById('f-cli-nombre').value.trim(),
    empresa: document.getElementById('f-cli-empresa').value.trim(),
    rubro: document.getElementById('f-cli-rubro').value.trim(),
    estado: document.getElementById('f-cli-estado').value,
    telefono: document.getElementById('f-cli-tel').value.trim(),
    email: document.getElementById('f-cli-email').value.trim(),
    score: parseInt(document.getElementById('f-cli-score').value) || 50,
    fechaAlta: document.getElementById('f-cli-fecha').value,
    notas: document.getElementById('f-cli-notas').value.trim()
  };
  if (!data.nombre) { toast('El nombre es obligatorio','error'); return; }
  if (editId) {
    const c = DB.clientes.find(x => x.id === editId);
    Object.assign(c, data); addTimeline(`Cliente actualizado: <strong>${data.nombre}</strong>`);
  } else {
    data.id = DB.nextId.clientes++;
    DB.clientes.push(data); addTimeline(`Nuevo cliente: <strong>${data.nombre}</strong> ‚Äî ${data.empresa}`);
  }
  saveDB(DB); closeModal(); renderClientes(); renderDashboard(); toast('Cliente guardado','success');
}

function saveProyecto(editId) {
  const data = {
    clienteId: parseInt(document.getElementById('f-proy-cliente').value) || null,
    nombre: document.getElementById('f-proy-nombre').value.trim(),
    servicio: document.getElementById('f-proy-servicio').value.trim(),
    precio: parseInt(document.getElementById('f-proy-precio').value) || 0,
    deadline: document.getElementById('f-proy-deadline').value,
    estado: document.getElementById('f-proy-estado').value,
    progreso: parseInt(document.getElementById('f-proy-progreso').value) || 0,
    notas: document.getElementById('f-proy-notas').value.trim()
  };
  if (!data.nombre) { toast('El nombre es obligatorio','error'); return; }
  if (editId) {
    const p = DB.proyectos.find(x => x.id === editId);
    Object.assign(p, data); addTimeline(`Proyecto actualizado: <strong>${data.nombre}</strong>`);
  } else {
    data.id = DB.nextId.proyectos++;
    DB.proyectos.push(data); addTimeline(`Nuevo proyecto: <strong>${data.nombre}</strong>`);
  }
  saveDB(DB); closeModal(); renderProyectos(); renderDashboard(); toast('Proyecto guardado','success');
}

function saveTarea() {
  const data = {
    id: DB.nextId.tareas++,
    texto: document.getElementById('f-tarea-texto').value.trim(),
    prioridad: document.getElementById('f-tarea-prioridad').value,
    categoria: document.getElementById('f-tarea-cat').value,
    fecha: document.getElementById('f-tarea-fecha').value,
    done: false
  };
  if (!data.texto) { toast('La descripci√≥n es obligatoria','error'); return; }
  DB.tareas.push(data); saveDB(DB); closeModal(); renderAgenda(); renderDashboard();
  addTimeline(`Nueva tarea: <strong>${data.texto}</strong>`); toast('Tarea creada','success');
}

function saveMovimiento() {
  const data = {
    id: DB.nextId.movimientos++,
    tipo: document.getElementById('f-mov-tipo').value,
    monto: parseFloat(document.getElementById('f-mov-monto').value) || 0,
    concepto: document.getElementById('f-mov-concepto').value.trim(),
    clienteId: parseInt(document.getElementById('f-mov-cliente').value) || null,
    moneda: document.getElementById('f-mov-moneda').value,
    fecha: document.getElementById('f-mov-fecha').value
  };
  if (!data.concepto) { toast('El concepto es obligatorio','error'); return; }
  DB.movimientos.push(data); saveDB(DB); closeModal(); renderFinanzas(); renderDashboard();
  addTimeline(`${data.tipo==='ingreso'?'Ingreso':'Gasto'}: <strong>$${formatMoney(data.monto)} ${data.moneda}</strong> ‚Äî ${data.concepto}`);
  toast('Movimiento registrado','success');
}

// ============================================================
// UTILITIES
// ============================================================
function formatMoney(n) { return n.toLocaleString('es-AR'); }

function addTimeline(texto) {
  DB.timeline.push({ texto, fecha: new Date().toLocaleString('es-AR') });
  if (DB.timeline.length > 50) DB.timeline = DB.timeline.slice(-50);
  saveDB(DB);
}

function toast(msg, type) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className = 'toast show ' + (type||'');
  setTimeout(() => t.className = 'toast', 3000);
}

// ============================================================
// SUPABASE MANAGER ‚Äî Cloud persistence with localStorage fallback
// ============================================================
const SUPABASE_CONFIG = {
  url: localStorage.getItem('divinia_supabase_url') || '',
  key: localStorage.getItem('divinia_supabase_key') || ''
};
let supabase = null;
let supabaseReady = false;

function initSupabase() {
  if (SUPABASE_CONFIG.url && SUPABASE_CONFIG.key && window.supabase_js) {
    try {
      supabase = window.supabase_js.createClient(SUPABASE_CONFIG.url, SUPABASE_CONFIG.key);
      supabaseReady = true;
      document.querySelector('#chat-wa-status .dot').className = 'dot online';
      document.querySelector('#chat-wa-status span:nth-child(2)').innerHTML = 'Supabase: Conectado <span class="cerebro-badge" style="margin-left:8px">‚úì Cloud</span>';
      console.log('Supabase connected');
    } catch(e) { console.warn('Supabase init error:', e); }
  }
}

function showSupabaseConfig() {
  const html = `<h2>‚öôÔ∏è Configuraci√≥n Cloud</h2>
    <div class="form-group"><label>Supabase URL</label><input id="f-sb-url" value="${SUPABASE_CONFIG.url}" placeholder="https://xxxxx.supabase.co"></div>
    <div class="form-group"><label>Supabase Anon Key</label><input id="f-sb-key" value="${SUPABASE_CONFIG.key}" placeholder="eyJhbGciOiJIUzI1NiIs..."></div>
    <div style="display:flex;gap:8px;margin-top:16px">
      <button class="btn btn-primary" onclick="saveSupabaseConfig()">üíæ Guardar y Conectar</button>
      <button class="btn" onclick="closeModal()">Cancelar</button>
    </div>
    <div style="margin-top:16px;padding:12px;background:var(--bg3);border-radius:8px;font-size:11px;color:var(--text2)">
      <strong>¬øNo ten√©s Supabase?</strong><br>
      1. Cre√° cuenta gratis en <a href="https://supabase.com" target="_blank" style="color:var(--cyan)">supabase.com</a><br>
      2. Nuevo proyecto ‚Üí Settings ‚Üí API<br>
      3. Copi√° URL y anon key ac√°
    </div>`;
  document.getElementById('modal-content').innerHTML = html;
  document.getElementById('modal-overlay').classList.add('show');
}

function saveSupabaseConfig() {
  const url = document.getElementById('f-sb-url').value.trim();
  const key = document.getElementById('f-sb-key').value.trim();
  if (!url || !key) { toast('Complet√° ambos campos','error'); return; }
  localStorage.setItem('divinia_supabase_url', url);
  localStorage.setItem('divinia_supabase_key', key);
  SUPABASE_CONFIG.url = url;
  SUPABASE_CONFIG.key = key;
  initSupabase();
  closeModal();
  toast('Supabase configurado','success');
}

async function migrateToSupabase() {
  if (!supabaseReady) return;
  const localDB = loadDB();
  for (const t of ['clientes','proyectos','tareas','movimientos','departamentos']) {
    if (localDB[t]?.length) {
      const { error } = await supabase.from(t).upsert(localDB[t]);
      if (error) console.warn('Migration error for ' + t, error);
    }
  }
  toast('Datos migrados a Supabase','success');
  addTimeline('Datos migrados a Supabase Cloud');
}

// ============================================================
// CEREBRO ‚Äî Intent Detection & Smart Suggestions
// ============================================================
const Cerebro = {
  patrones: {
    cotizacion: /cotizaci[√≥o]n|precio|cu[√°a]nto\s*(cuesta|sale|cobr)|presupuesto|tarifa/i,
    propuesta: /propuesta|interesado|me\s*interesa|quiero\s*contratar/i,
    confirmacion: /confirmo|listo|dale|ok|perfecto|de\s*acuerdo|trato\s*hecho/i,
    soporte: /problema|error|no\s*funciona|ayuda|bug|falla|se\s*cay√≥/i,
    saludo: /hola|buen[oa]s|buenas?\s*(tardes?|noches?|d[i√≠]as?)|qu√©?\s*tal/i,
    urgente: /urgente|emergencia|ya\s*mismo|ahora|cuanto\s*antes/i
  },

  detectar(texto) {
    for (const [intent, regex] of Object.entries(this.patrones)) {
      if (regex.test(texto)) return intent;
    }
    return 'general';
  },

  sugerencias(intent) {
    const templates = {
      cotizacion: [
        "Te paso nuestro cat√°logo de servicios. ¬øQu√© tipo de soluci√≥n busc√°s?",
        "Tenemos chatbots WhatsApp desde $150.000 y webs desde $100.000. ¬øQu√© necesit√°s?",
        "¬øPodemos agendar una videollamada para entender mejor tu necesidad?"
      ],
      propuesta: [
        "¬°Genial! Te preparo una propuesta formal esta semana.",
        "Perfecto, te armo el presupuesto detallado con plazos y entregables.",
        "Agendamos una reuni√≥n para definir alcance y cerrar?"
      ],
      confirmacion: [
        "¬°Excelente! Te env√≠o el link de MercadoPago para el 50% de adelanto.",
        "Perfecto, arrancamos. Te paso el cronograma del proyecto.",
        "Genial, quedamos as√≠. Ma√±ana te mando el primer avance."
      ],
      soporte: [
        "Entendido, lo reviso ahora mismo. ¬øMe pod√©s mandar un screenshot?",
        "Lo estamos viendo. Te doy una soluci√≥n en las pr√≥ximas 2 horas.",
        "Gracias por avisar, ya lo deriv√© al equipo t√©cnico."
      ],
      saludo: [
        "¬°Hola! ¬øEn qu√© te puedo ayudar hoy?",
        "Buenas, ¬øc√≥mo and√°s? ¬øNecesit√°s algo de DIVINIA?",
        "¬°Hola! Soy Joaco de DIVINIA. ¬øQu√© necesit√°s?"
      ],
      urgente: [
        "Lo veo ahora mismo, dame 10 minutos.",
        "Entendido, es prioridad. Ya lo estamos resolviendo.",
        "Lo paso como urgente al equipo. Te aviso apenas est√©."
      ],
      general: [
        "Gracias por tu mensaje. ¬øEn qu√© puedo ayudarte?",
        "¬°Hola! Contame m√°s sobre lo que necesit√°s.",
        "Recibido, te respondo a la brevedad."
      ]
    };
    return templates[intent] || templates.general;
  },

  procesarMensaje(texto, telefono) {
    const intent = this.detectar(texto);
    const sugerencias = this.sugerencias(intent);
    // Auto-create task for urgent or support
    if (intent === 'urgente' || intent === 'soporte') {
      const conv = chatConversaciones.find(c => c.telefono === telefono);
      const nombre = conv?.nombre || telefono;
      DB.tareas.push({
        id: DB.nextId.tareas++,
        texto: `‚ö° ${intent === 'urgente' ? 'URGENTE' : 'SOPORTE'}: ${nombre} ‚Äî "${texto.substring(0, 60)}..."`,
        prioridad: 'alta',
        categoria: intent === 'urgente' ? 'llamada' : 'deploy',
        fecha: new Date().toISOString().split('T')[0],
        done: false
      });
      saveDB(DB);
      addTimeline(`Cerebro: tarea auto-creada para ${nombre} (${intent})`);
    }
    return { intent, sugerencias };
  }
};

// ============================================================
// CHAT SYSTEM ‚Äî Conversations & Messages
// ============================================================
let chatConversaciones = [];
let chatMensajes = {};
let chatActivo = null;
const CHAT_KEY = 'divinia_chat';

function loadChat() {
  const raw = localStorage.getItem(CHAT_KEY);
  if (raw) {
    const data = JSON.parse(raw);
    chatConversaciones = data.conversaciones || [];
    chatMensajes = data.mensajes || {};
  }
  if (!chatConversaciones.length) {
    chatConversaciones = [
      { id: 1, telefono: '542665000001', nombre: 'Ediro (Sec. Transporte)', clienteId: 1, ultimoMsg: 'Hola Joaco, ¬øc√≥mo viene TUBI?', ultimoTime: '2026-02-17 14:30', unread: 1 }
    ];
    chatMensajes['542665000001'] = [
      { id: 1, tipo: 'recibido', texto: 'Hola Joaco, ¬øc√≥mo viene TUBI?', hora: '14:30', fecha: '2026-02-17' },
      { id: 2, tipo: 'enviado', texto: 'Hola Ediro! Viene bien, estamos al 60%. Esta semana te muestro el avance.', hora: '14:35', fecha: '2026-02-17' },
      { id: 3, tipo: 'recibido', texto: 'Perfecto, el viernes podemos?', hora: '14:37', fecha: '2026-02-17' }
    ];
  }
}

function saveChat() {
  localStorage.setItem(CHAT_KEY, JSON.stringify({
    conversaciones: chatConversaciones,
    mensajes: chatMensajes
  }));
}

let chatNextId = 100;

function renderConversaciones() {
  const el = document.getElementById('chat-conversations');
  el.innerHTML = chatConversaciones.length ? chatConversaciones.sort((a,b) => (b.ultimoTime||'').localeCompare(a.ultimoTime||'')).map(c => {
    const initials = (c.nombre || c.telefono).substring(0, 2).toUpperCase();
    return `<div class="chat-contact ${chatActivo === c.telefono ? 'active' : ''}" onclick="openChat('${c.telefono}')">
      <div class="chat-avatar">${initials}</div>
      <div class="chat-contact-info">
        <div class="chat-contact-name">${c.nombre || c.telefono}</div>
        <div class="chat-contact-preview">${c.ultimoMsg || '‚Äî'}</div>
      </div>
      <div style="text-align:right">
        <div class="chat-contact-time">${(c.ultimoTime||'').split(' ')[1] || ''}</div>
        ${c.unread ? `<div class="chat-contact-badge">${c.unread}</div>` : ''}
      </div>
    </div>`;
  }).join('') : '<div class="empty-state"><span class="icon">üí¨</span>Sin conversaciones</div>';
}

function openChat(telefono) {
  chatActivo = telefono;
  const conv = chatConversaciones.find(c => c.telefono === telefono);
  if (conv) conv.unread = 0;
  saveChat();

  document.getElementById('chat-empty').style.display = 'none';
  document.getElementById('chat-active').style.display = 'flex';
  document.getElementById('chat-contact-name').textContent = conv?.nombre || telefono;

  const cli = conv?.clienteId ? DB.clientes.find(c => c.id === conv.clienteId) : null;
  document.getElementById('chat-contact-status').textContent = cli ? `Cliente: ${cli.empresa}` : `+${telefono}`;

  renderMensajes();
  renderConversaciones();
  document.getElementById('chat-input').focus();
}

function renderMensajes() {
  if (!chatActivo) return;
  const msgs = chatMensajes[chatActivo] || [];
  const el = document.getElementById('chat-messages');
  let lastDate = '';
  el.innerHTML = msgs.map(m => {
    let dateDiv = '';
    if (m.fecha !== lastDate) {
      lastDate = m.fecha;
      dateDiv = `<div class="chat-date-divider"><span>${m.fecha}</span></div>`;
    }
    return `${dateDiv}<div class="chat-bubble-wrap ${m.tipo}">
      <div class="chat-bubble ${m.tipo}">${m.texto}</div>
      <span class="chat-bubble-time">${m.hora}${m.tipo === 'enviado' ? ' ‚úì‚úì' : ''}</span>
    </div>`;
  }).join('');
  el.scrollTop = el.scrollHeight;
  // Hide suggestions
  document.getElementById('chat-suggestions').style.display = 'none';
}

function sendMessage() {
  const input = document.getElementById('chat-input');
  const texto = input.value.trim();
  if (!texto || !chatActivo) return;

  const now = new Date();
  const hora = now.toTimeString().substring(0, 5);
  const fecha = now.toISOString().split('T')[0];

  if (!chatMensajes[chatActivo]) chatMensajes[chatActivo] = [];
  chatMensajes[chatActivo].push({
    id: chatNextId++, tipo: 'enviado', texto, hora, fecha
  });

  const conv = chatConversaciones.find(c => c.telefono === chatActivo);
  if (conv) { conv.ultimoMsg = texto; conv.ultimoTime = `${fecha} ${hora}`; }

  input.value = '';
  saveChat();
  renderMensajes();
  renderConversaciones();

  // Send via WhatsApp API if connected
  if (supabaseReady) {
    sendWhatsApp(chatActivo, texto);
  }
}

function simulateReceive(telefono, texto) {
  const now = new Date();
  const hora = now.toTimeString().substring(0, 5);
  const fecha = now.toISOString().split('T')[0];

  if (!chatMensajes[telefono]) chatMensajes[telefono] = [];
  chatMensajes[telefono].push({
    id: chatNextId++, tipo: 'recibido', texto, hora, fecha
  });

  const conv = chatConversaciones.find(c => c.telefono === telefono);
  if (conv) {
    conv.ultimoMsg = texto;
    conv.ultimoTime = `${fecha} ${hora}`;
    if (chatActivo !== telefono) conv.unread = (conv.unread || 0) + 1;
  }

  // Cerebro processes
  const result = Cerebro.procesarMensaje(texto, telefono);
  if (chatActivo === telefono) {
    showSugerencias(result.sugerencias);
    renderMensajes();
  }

  saveChat();
  renderConversaciones();
  toast(`Nuevo mensaje de ${conv?.nombre || telefono}`, 'success');
}

function showSugerencias(sugerencias) {
  const el = document.getElementById('chat-suggestions');
  el.style.display = 'flex';
  el.innerHTML = '<span style="font-size:10px;color:var(--text3);width:100%">üß† Cerebro sugiere:</span>' +
    sugerencias.map(s => `<div class="chat-suggestion" onclick="useSugerencia(this)">${s}</div>`).join('');
}

function useSugerencia(el) {
  document.getElementById('chat-input').value = el.textContent;
  document.getElementById('chat-suggestions').style.display = 'none';
  document.getElementById('chat-input').focus();
}

async function sendWhatsApp(telefono, texto) {
  try {
    const resp = await fetch('/api/send-whatsapp', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ telefono, contenido: texto })
    });
    if (resp.ok) console.log('WhatsApp sent');
    else console.warn('WhatsApp send failed');
  } catch(e) { console.warn('WhatsApp API not available:', e.message); }
}

function openWhatsAppDirect() {
  if (!chatActivo) return;
  window.open(`https://wa.me/${chatActivo}`, '_blank');
}

function vincularClienteChat() {
  if (!chatActivo) return;
  const conv = chatConversaciones.find(c => c.telefono === chatActivo);
  const options = DB.clientes.map(c => `<option value="${c.id}"${conv?.clienteId === c.id ? ' selected' : ''}>${c.nombre} ‚Äî ${c.empresa}</option>`).join('');
  const html = `<h2>üîó Vincular a Cliente</h2>
    <div class="form-group"><label>Cliente</label><select id="f-vincular-cli"><option value="">Sin vincular</option>${options}</select></div>
    <button class="btn btn-primary" onclick="saveVinculacion()" style="margin-top:12px">Guardar</button>`;
  document.getElementById('modal-content').innerHTML = html;
  document.getElementById('modal-overlay').classList.add('show');
}

function saveVinculacion() {
  const cliId = parseInt(document.getElementById('f-vincular-cli').value) || null;
  const conv = chatConversaciones.find(c => c.telefono === chatActivo);
  if (conv) { conv.clienteId = cliId; saveChat(); openChat(chatActivo); }
  closeModal();
  toast('Cliente vinculado', 'success');
}

function renderChat() {
  loadChat();
  renderConversaciones();
  if (chatActivo) openChat(chatActivo);
}

// ============================================================
// INIT
// ============================================================
document.getElementById('topbar-date').textContent = new Date().toLocaleDateString('es-AR', { weekday:'long', year:'numeric', month:'long', day:'numeric' });
loadChat();
renderDashboard();

// Try to init Supabase if configured
if (SUPABASE_CONFIG.url && SUPABASE_CONFIG.key) {
  const sbScript = document.createElement('script');
  sbScript.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2';
  sbScript.onload = () => { window.supabase_js = window.supabase; initSupabase(); };
  document.head.appendChild(sbScript);
}
</script>
</body>
</html>
